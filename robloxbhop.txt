local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local plr = Players.LocalPlayer
local char = plr.Character or plr.CharacterAdded:Wait()
local hum = char:WaitForChild("Humanoid")
local hrp = char:WaitForChild("HumanoidRootPart")

local baseSpeed = 17
local speedCap = 100
local decelRate = 50
local lowFriction = 0.7 -- less slippery
local currSpeed = baseSpeed

local origProps = hrp.CustomPhysicalProperties or PhysicalProperties.new(0.7,0.3,0.5,1,1)
local slipProps = PhysicalProperties.new(origProps.Density, lowFriction, origProps.Elasticity,100,origProps.ElasticityWeight)

local lastHzSpeed = 0
local lastDir = Vector3.new(0,0,0)
local sliding = false

-- main heartbeat loop
RunService.Heartbeat:Connect(function(dt)
    local moveDir = hum.MoveDirection
    local hzVel = Vector3.new(hrp.Velocity.X, 0, hrp.Velocity.Z)

    -- âœ… Half-Life style air acceleration
    if not hum.FloorMaterial and moveDir.Magnitude > 0 then
        local wishDir = moveDir.Unit
        local wishSpeed = 50
        local accel = 250

        local currentSpeed = hzVel:Dot(wishDir)
        local addSpeed = wishSpeed - currentSpeed
        if addSpeed > 0 then
            local accelSpeed = math.min(accel * dt * wishSpeed, addSpeed)
            hrp.Velocity += Vector3.new(wishDir.X * accelSpeed, 0, wishDir.Z * accelSpeed)
        end
    end

    if moveDir.Magnitude > 0 then
        lastDir = moveDir.Unit
        sliding = false
        hrp.CustomPhysicalProperties = origProps
    end

    local hzSpeedNow = (hrp.Velocity * Vector3.new(1,0,1)).Magnitude
    if hzSpeedNow < lastHzSpeed * 0.5 and lastHzSpeed > baseSpeed * 1.5 then
        currSpeed = baseSpeed
        hum.WalkSpeed = baseSpeed
        sliding = false
        hrp.CustomPhysicalProperties = origProps
    end
    lastHzSpeed = hzSpeedNow

    if moveDir.Magnitude == 0 and currSpeed > baseSpeed then
        if not sliding then
            sliding = true
            hrp.CustomPhysicalProperties = slipProps
            hrp.Velocity = Vector3.new(lastDir.X * currSpeed, hrp.Velocity.Y, lastDir.Z * currSpeed)
        end
        currSpeed = math.max(baseSpeed, currSpeed - decelRate * dt)
        hum.WalkSpeed = currSpeed
        local velHz = hrp.Velocity * Vector3.new(1,0,1)
        if velHz.Magnitude > baseSpeed then
            hrp.Velocity = Vector3.new(lastDir.X * currSpeed, hrp.Velocity.Y, lastDir.Z * currSpeed)
        else
            sliding = false
            hrp.CustomPhysicalProperties = origProps
            hum.WalkSpeed = baseSpeed
            currSpeed = baseSpeed
        end
    elseif moveDir.Magnitude == 0 then
        currSpeed = baseSpeed
        hum.WalkSpeed = baseSpeed
        sliding = false
        hrp.CustomPhysicalProperties = origProps
    else
        hum.WalkSpeed = currSpeed
    end
end)
