local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local plr = Players.LocalPlayer
local char = plr.Character or plr.CharacterAdded:Wait()
local hum = char:WaitForChild("Humanoid")
local hrp = char:WaitForChild("HumanoidRootPart")

local baseSpeed = 16
local speedCap = 100
local decelRate = 50
local lowFriction = 0.7
local currSpeed = baseSpeed

local origProps = hrp.CustomPhysicalProperties or PhysicalProperties.new(0.7,0.3,0.5,1,1)
local slipProps = PhysicalProperties.new(origProps.Density, lowFriction, origProps.Elasticity,100,origProps.ElasticityWeight)

local lastHzSpeed = 0
local lastDir = Vector3.new(0,0,0)
local sliding = false
local airTurnRate = 20 -- higher = faster air turning
local cam = workspace.CurrentCamera

RunService.Heartbeat:Connect(function(dt)
    local moveDir = hum.MoveDirection
    local hzVel = Vector3.new(hrp.Velocity.X,0,hrp.Velocity.Z)
    local speed = hzVel.Magnitude

    -- AIR TURNING (Half-Life style)
    if not hum.FloorMaterial and moveDir.Magnitude > 0 then
        local camLook = Vector3.new(cam.CFrame.LookVector.X, 0, cam.CFrame.LookVector.Z).Unit
        local desiredDir = (moveDir + camLook).Unit
        local newDir = hzVel.Magnitude > 0 and hzVel.Unit:Lerp(desiredDir, math.clamp(airTurnRate * dt, 0, 1)) or desiredDir
        hrp.Velocity = Vector3.new(newDir.X * speed, hrp.Velocity.Y, newDir.Z * speed)
    end

    -- ground slide + reset stuff
    if moveDir.Magnitude > 0 then
        lastDir = moveDir.Unit
        sliding = false
        hrp.CustomPhysicalProperties = origProps
    end

    local hzSpeedNow = (hrp.Velocity * Vector3.new(1,0,1)).Magnitude
    if hzSpeedNow < lastHzSpeed * 0.5 and lastHzSpeed > baseSpeed * 1.5 then
        currSpeed = baseSpeed
        hum.WalkSpeed = baseSpeed
        sliding = false
        hrp.CustomPhysicalProperties = origProps
    end
    lastHzSpeed = hzSpeedNow

    if moveDir.Magnitude == 0 and currSpeed > baseSpeed then
        if not sliding then
            sliding = true
            hrp.CustomPhysicalProperties = slipProps
            hrp.Velocity = Vector3.new(lastDir.X * currSpeed, hrp.Velocity.Y, lastDir.Z * currSpeed)
        end
        currSpeed = math.max(baseSpeed, currSpeed - decelRate * dt)
        hum.WalkSpeed = currSpeed
        local velHz = hrp.Velocity * Vector3.new(1,0,1)
        if velHz.Magnitude > baseSpeed then
            hrp.Velocity = Vector3.new(lastDir.X * currSpeed, hrp.Velocity.Y, lastDir.Z * currSpeed)
        else
            sliding=false
            hrp.CustomPhysicalProperties=origProps
            hum.WalkSpeed=baseSpeed
            currSpeed=baseSpeed
        end
    elseif moveDir.Magnitude==0 then
        currSpeed=baseSpeed
        hum.WalkSpeed=baseSpeed
        sliding=false
        hrp.CustomPhysicalProperties=origProps
    else
        hum.WalkSpeed=currSpeed
    end
end)
